$schema: ../json_schemas/test_story.schema.yaml

skip: false
description: |
  This test story checks that we can create an ingest pipeline with a text 
  embedding processor a uses it to create an index.
epilogues:
  - path: /_ingest/pipeline/books_pipeline
    method: DELETE
    status: [200, 404]
  - path: /books
    method: DELETE
    status: [200, 404]
chapters:
  - synopsis: Create ingest pipeline with a text embedding processor
    path: /_ingest/pipeline/{id}
    method: PUT
    parameters:
      id: books_pipeline
    request_body:
      payload:
        description: "Extracts text from field and embeds it"
        processors:
          - text_embedding:
              model_id: "7Dkh5o8B0KaoPRUDoL2d"
              field_map:
                text: "passage_embedding"
    response:
      status: 200
      payload:
        acknowledged: true
  - synopsis: Create an index using the pipeline
    path: /{index}
    method: PUT
    parameters:
      index: books
    request_body:
      payload:
        settings:
          index.knn: true
          default_pipeline: books_pipeline
        mappings:
          properties:
            passage_embedding:
              type: "knn_vector"
              dimension: 768
              method:
                engine: "lucene"
                space_type: "l2"
                name: "hnsw"
                parameters: {}
    response:
      status: 200
      payload:
        acknowledged: true
  - synopsis: Ingest document with pipeline
    path: /{index}/_doc/{id}
    method: POST
    parameters:
      index: books
      id: "1"
    request_body:
      payload:
        text: "The quick brown fox jumps over the lazy dog"
        id: 1
    response:
      status: 200
